#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <math.h>

char *A = "~\\^__a^\\Z~\\\\^_ZZffa~\\^__a^\\Z~\\\\^_\\Zaaaca~_~ac_aaacaZ~\\^_\\aca~ZZZ\\ccaZZ\\Zaa_ZZ\\Z_a^\\ZZa_ZZ\\Zcca~ZZ\\Zf^_^\\ZZ\\Z_a^\\ZZa_~__\\_a~^\\Z~\\\\^_\\Zffaca_\\\\^_\\_a^\\Z~\\\\^_\\Z~acca_~ac_aaacaZ~\\^_\\aca~ZZZ\\ccaZZ\\Zaa_ZZ\\Z_a^\\ZZa_ZZ\\ZccaZZ\\Zf^_^\\ZZ\\Z_a^\\ZZa_~ZZ\\ZccaZZ\\Zaa_ZZ\\Z_a^\\ZZa_ZZ\\";
char *B = "?<<<<<=;?E<<<<><><>D<<<<<=;?E<<<<<><<<<?=C;<<<<<<<>>B<<<><<?;;;;;==@;;;;==@;;;;><=;><>B;;;;==?;;;;;><;;>;;;;><=;><>@B<<<<?=<<@@<<<<<@<<><<><<<<<<><<@@<<<<<?;<<>@C;<<<<<<<>>B<<<><<?;;;;;==@;;;;==@;;;;><=;><>B;;;;==@;;;;><;;>;;;;><=;><>@<;;;;==@;;;;==@;;;;><=;><>B;;;";
char *C = "~L~N~K~L~L~N~K~L~L~N~K~L~L~N~K~D~D~B~B~D~D~B~B~L~N~K~L~L~N~K~L~L~N~K~L~L~N~K~L~L~N~K~L~L~N~K~L~L~N~K~L~D~D~B~B~D~D~B~B~L~N~K~L~L~N~K~L~L~N~K~L~L~N~K~L~L~N~K~L~L~N~K~L";
char *D = ";?;???;>@?;???;>@?;???;???;>@D@?;???;???;???;???;???;???;???;???;???;???;???;???;???;???;???;???;???;???;???;???;???;???;???;???;???;???;???;???;???;???;???;???;???;???;???;?";
char E[] = "ZxZxZxZxZxZxZl`<^<ZxZ>_>^>ZxZ<Nb@NZxZ<NTRd<NZxZ<QNQb>ZxZ>Q[<b<ZxZ>QVQRZxZBh<RZxZBh<RWh<ZxZ<h<QWhBZtOJVg<hDZnh<OJg<hHZjh@Jg<hHZjh@Jg<hHZjh@Jg<hHZjh@Jg<hJZhh@Jg<Qh@Yh>Zhh@Jg<a<h>Yh>Zhh@Jg<Xa<h<Yh@ZH~";
char G[] = "ZxZxZxZ>]<^<ZxZ@^<_<NZxZ>Na<RNZxZ>MQRSNZxZ<RPLRLQZxZ<a<VQRQZxZ>QVQRZxZ@a<RZxZBa<RZxZBa>Wh<Zv_<Wh<WhDZlXOXOWh<WhFZjh@Wh<WhFZjXYh>Jg<hFZjhBJg<hFZjhBJWhJZhhBJWh<Qb<Xi<h<Zfi>h<JWh<Qb<XYh@Zbh<i<h<JWh>a<YhBZbh@QXJWh>i>hDZbh<a>JWXiBhBZdi<Ra<JXiFZP~";
char H[] = "ZxZxZxZxZL`BZxZ>N_<^<ZxZ>TQRSTZxZ<TQKb<TZxZ<La<RTZxZ>a>KRQZxZ>Va<RZxZ@f<RZxZBa<RWZxZ>WQh<Wh<ZtOXOWJh<Wh@Znh@g<h<WhBZjhBg<JWhFZhhDWJWhFZhhDWJWhFZhXYh@WJhHZhXYh@WJhHZhXi<h>WJh>a<Rh<ZhXi<h>WJh>b<Qh<ZhXi<h>WJh>a>h<ZhXi>h<WJh>YQh>ZP~";
char *I = "/usr/bin/aplay";
char *J = "r.raw";
char *h[] = { E, G, G, H, H, G, G, E };

int f[64], outputIndex = 0, waveFrequency = 0;
int i = 0, soundProcess = 0, soundSegment = 0, j, duration, x, color, isSoundPlaying = 0;
int Z = 704000;
int g[] = { 9474192, 11302972, 13664348, 14718064, 6572056, 4466688, 9985064, 13660272, 14715016, 15507616, 8677424, 11549756, 12605528, 13158600, 4210752, 2895872 };

void generateSoundWave(char *N, char *L) {
    char *note = N;
    char *length = L;
    while (*note) {
        duration = (*length - 58) * 1000;
        waveFrequency = *note > 'z' ? 0 : 8000 / f[*note - 58];
        for (j = 0; j < duration; j++, outputIndex++) {
            if (waveFrequency && (j % waveFrequency < waveFrequency / 2)) {
                b[outputIndex] += (j > duration / 2) ? 32 : 63;
            }
        }
        note++;
        length++;
    }
}

int main(int argc, char **argv) {
    FILE *audioFile;
    for (i = 0; i < 64; i++) {
        f[i] = 440 * pow(2, (i - 45) / 12.0);
    }
    if (!(b = calloc(Z, 1))) {
        return 1;
    }
    generateSoundWave(A, B);
    outputIndex = 0;
    generateSoundWave(C, D);

    if (!fork()) {
        if ((audioFile = fopen(I, "r"))) {
            fclose(audioFile);
            audioFile = popen(I, "w");
            soundProcess = 1;
        } else {
            audioFile = fopen(J, "w");
        }
        if (audioFile) {
            fwrite(b, Z, 1, audioFile);
        }
        if (!soundProcess) {
            fclose(audioFile);
        } else {
            pclose(audioFile);
        }
        for (;;) {}
    }

    for (;;) {
        char *waveform = h[soundSegment++ & 7];
        x = 0;
        printf("\x1b[1;1H");
        while (*waveform < '~') {
            color = *waveform - 58;
            int repeatCount = color < 16 ? 1 : color < 32 ? 2 : *(++waveform) - 56;
            color &= 15;
            printf("\x1b[48;2;%d;%d;%dm", (g[color] >> 16) & 255, (g[color] >> 8) & 255, g[color] & 255);
            for (i = 0; i < repeatCount; i++, x++) {
                printf(x % 80 ? " " : "\n ");
            }
            waveform++;
        }
        usleep(Z / 3);
    }

    return 0;
}