#include <stdio.h>
#include <unistd.h>

#define MAX_SIZE 9999

void P(int c) {
    int i = M * N;
    for (; i--;) {
        A[i % N][i / N] = (!(c = A[i % N][i / N]) ? 32 : c);
    }
}

void Q(int t, int d) {
    for (int i, j, k = ~d / 2 * 3 + 3, l; j = k != 2, k - (3 + 5 * d) / 2; k += d) {
        long long m = M * N, n = j ? M : N, u = (2 * k - k / 2 * 3 - k / 3 * 5) * d, x, y, w, s;
        for (i = m; i--;) B[i % N][i / N] = A[i % N][i / N];
        for (i = n; i--;) {
            s = S + k;
            for (w = 0, l = 6; l -= 2;) {
                s = (s + T) * W % X;
                x = l * i + s % W * n * t / W / 5 + n * (n + s % W) - n * t / 10;
                w += x % n * (n - x % n) * (x / n % 2 * 2 - 1) * (3 + k % 3 + k / 2);
                w = (w + n * n / (w > 0 ? 2 : -2)) / n / n;
                for (l = j ? N : M; l--; x = j * i + u) {
                    y = !j * i + d * j * l + m * 4;
                    A[y % N][x % M] = B[(y + d * j * w) % N][(x + u * w) % M];
                }
            }
        }
    }
}

int main(int argc, char **argv) {
    char *s;
    int x = 0, y = 0, i, j, n[256] = {0}, a, b, c;
    W = 33331;
    X = 33333331;
    N = 40;
    S = T = 0;

    if (+--argc && sscanf(*++argv, "%ld", &N)) {
        --argc;
        argv++;
    }

    if (argc) {
        for (s = *argv++; *s;) {
            T = (T * W + *s++) % X;
        }
    }

    for (; (c = getchar()) >= 0; n[c]++) {
        c - 10 ? A[y][x++] = c : (y++, x = 0);
    }

    M = 2 * N;
    P(0);

    for (i = 33; i < 127; i++) {
        S = (3331 * S + n[i]) % W;
    }

    for (i = c = 0; 128 > i; i++) {
        x = -(6 >> i / 32) % 2 * 2 + 1;
        Q((96 + i * x + ~-x / 2) % 32, x);

        for (j = a = 0; i % 64 == 31 && j < N * M; b = A[j / M][j % M] & 95, c += x * (a | !b && (j % M)), a = b, j++);
    }

    for (x = 0; 32 >= x; x++) {
        j = MAX_SIZE;
        while (j--) {
            s = A[j];
            while (*s) s++;
            while (*--s == 32) *s = 0;
        }

        for (j = x / 32, a = ~-MAX_SIZE; ~j; j--) {
            for (; a && !*A[a];) a--;
            fprintf(stderr, x ? "%s" : "%s\033[2J", "\033[H");
            for (i = 0; j ? i <= a : i < y || i < N; i++) {
                !j ? !fprintf(stderr, "%s\033[K\n", A[i]) : puts(A[i]);
            }
        }

        P(0);
        if (x - 32) c < 0 ? Q(31 - x, -1) : Q(x, 1);
        usleep(W << 1);
    }
}