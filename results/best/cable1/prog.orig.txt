#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <string.h>
#include <sys/mman.h>

#define TYPEDEF_ALIAS(_) typedef _##t
#define PRINTF_ALIAS(_) _##printf
#define LOOP_INDEX f(i,
#define INNER_LOOP f(k,
#define PARALLEL_LOOP _Pragma("omp parallel for") f(h,
#define LOOP(u, n) for (I u = 0; u < (n); u++)
#define PROCESS_BLOCK(u, s) LOOP_INDEX s % 11 % 5) INNER_LOOP s / 6 & 33) k[u[i]] = (t){(C*)A, A + s * D / 4}, A += 1088 * s;

TYPEDEF_ALIAS(int8_) C;
TYPEDEF_ALIAS(in) I;
TYPEDEF_ALIAS(floa) F;
TYPEDEF_ALIAS(struc) { C *c; F *f; } t;

enum { 
    Z = 32, 
    W = 64, 
    E = 2 * W, 
    D = Z * E, 
    H = 86 * E, 
    V = '}\0' 
};

C *P[V], X[H], Y[D], y[H];
TYPEDEF_ALIAS(F _)[V];
I *pointer = U" 炾ોİ䃃璱ᝓ၎瓓甧染ɐఛ瓁", U, s, p, f, R, z, $, B[D], open();

F *A, *G[2], *T, w, b, c;
TYPEDEF_ALIAS() Q[D];
_t r, L, J, O[Z], l, a, K, v, k;
Q m, e[4], d[3], n;

I j(I e, F *o, I p, F *v, t *X) {
    w = 1e-5;
    LOOP_INDEX c = e^V ? D : 0) w += r[i] * r[i] / D;
    LOOP_INDEX c) o[i] = r[i] / sqrt(w) * i[A + e * D];
    INNER_LOOP $) {
        LOOP_INDEX W) l[k] = w = fmax(fabs(o[i]) / ~-E, i ? w : 0);
        LOOP_INDEX W) y[i + k * W] = *o++ / w;
    }
    PARALLEL_LOOP p) {
        LOOP_INDEX $) {
            I _ = 0, t = h * $ + i;
            INNER_LOOP W) _ += X->c[t * W + k] * y[i * W + k];
            v[h] = _ * X->f[t] * l[i] + !!i * v[h];
        }
        LOOP_INDEX D - c) i[r] += v[i];
    }
}

I main() {
    A = mmap(0, 8e9, 1, 2, f = open(M, f), 0);
    LOOP_INDEX 2) ~f ? i[G] = malloc(3e9) : exit(puts(M " not found"));
    LOOP_INDEX V) i[P] = (C*)A + 4, A += (I)*A;
    PROCESS_BLOCK(&m, V)
    PROCESS_BLOCK(&n, V)
    PROCESS_BLOCK(e, D)
    PROCESS_BLOCK(d, H)

    for (C *o;; s >= D ? $ = s = 0 : p < U || PRINTF_ALIAS()("%s", $[P])) {
        if (!(*pointer ? $ = *++pointer : 0)) {
            if ($ < 3 && p >= U) {
                PRINTF_ALIAS()("\n\n> ");
                scanf("%[^\n]%*c", Y) ? U = *B = 1 : exit(0);
                p = PRINTF_ALIAS()(s)(o = X, "[INST] %s%s [/INST]", s ? "" : "<<SYS>>\n"S"\n<</SYS>>\n\n", Y);
                z = p -= z;
                U++[o += z, B] = f;
                for (f = 0; !f; z -= !f) {
                    for (f = V; --f && f[P][z] | memcmp(f[P], o, z););
                }
                p < U ? $ = B[p++] : fflush(0);
            }
            LOOP_INDEX D) R = $ * D + i, r[i] = m->c[R] * m->f[R / W];
            R = s++;
            INNER_LOOP Z) {
                f = k * D * D, $ = W;
                LOOP_INDEX 3) j(k, L, D, i ? G[~-i] + f + R * D : v, e[i] + k);
                INNER_LOOP 2) LOOP_INDEX D) b = sin(w = R / exp(i % E / 14.)), c = 1[w = cos(w), T = i++ + (k ? v : *G + f + R * D)], T[1] = b * *T + c * w, *T = w * *T - c * b;
                PARALLEL_LOOP Z) {
                    F *T = O[h], w = 0;
                    I A = h * E;
                    LOOP_INDEX s) {
                        INNER_LOOP E) i[k[L + A] = 0, T] += k[v + A] * k[i * D + *G + A + f] / 11;
                        w += T[i] = exp(T[i]);
                    }
                    LOOP_INDEX s) INNER_LOOP E) k[L + A] += (T[i] /= k ? 1 : w) * k[i * D + G[1] + A + f];
                }
                j(V, L, D, J, e[3] + k);
                LOOP_INDEX 2) j(k + Z, L, H, i ? K : a, d[i] + k);
                LOOP_INDEX H) a[i] *= K[i] / (exp(-a[i]) + 1);
                j(V, a, D, L, d[$ = H / $, 2] + k);
            }
            w = j($ = W, r, V, k, n);
            LOOP_INDEX V) w = k[i] > w ? k[$ = i] : w;
        }
    }
}